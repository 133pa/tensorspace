<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TensorSpace - Yolo_v3_tiny_coco Demo ( TODO )</title>
        <meta name="author" content="Charlesliuyx / https://github.com/Charlesliuyx">
        <style>

            html, body {
                 margin: 0;
                 padding: 0;
                 width: 100%;
                 height: 100%;
             }

            #container {
                width: 100%;
                height: 100%;
            }

            #loadingPad {
                position: fixed;
                height: 100%;
                width: 100%;
                top: 0;
                left: 0;
                background-color: #031D32;
                z-index: 2;
            }

            #loading {
                position: fixed;
                width: 30%;
                top: 150px;
                margin-left: 35%;
            }

        </style>
    </head>
    <body>

        <div id="container"></div>
        <div id="loadingPad">
            <img id="loading" src="./assets/loading.gif">
        </div>

        <script src="../lib/jquery.min.js"></script>
        <script src="../lib/three.min.js"></script>
        <script src="../lib/stats.min.js"></script>
        <script src="../lib/tween.min.js"></script>
        <script src="../lib/TrackballControls.js"></script>
        <script src="../lib/tf.min.js"></script>
        <script src="../../build/tensorspace.js"></script>

        <script>

            // TODO

            let modelContainer = document.getElementById( "container" );

            let input = new TSP.layers.RGBInput( {
                shape: [ 416, 416, 3 ],  name: "Input"
            });

            let conv2d_1 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 16, strides: 1, padding: "same", name: "conv2d_1"
            } );

            conv2d_1.apply( input );

            let max_pooling2d_1 = new TSP.layers.Pooling2d( {
                poolSize: [2, 2],  strides: [2, 2],  padding: "same", name: "max_pooling2d_1"
            } );

            max_pooling2d_1.apply( conv2d_1 );

            let conv2d_2 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 32, strides: 1, padding: "same", name: "conv2d_2"
            } );

            conv2d_2.apply( max_pooling2d_1 );

            let max_pooling2d_2 = new TSP.layers.Pooling2d( {
                poolSize: [2, 2],  strides: [2, 2],  padding: "same", name: "max_pooling2d_2"
            } );

            max_pooling2d_2.apply( conv2d_2 );

            let conv2d_3 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 64, strides: 1, padding: "same", name: "conv2d_3"
            } );

            conv2d_3.apply( max_pooling2d_2 );

            let max_pooling2d_3 = new TSP.layers.Pooling2d( {
                poolSize: [2, 2],  strides: [2, 2],  padding: "same", name: "max_pooling2d_3"
            } );

            max_pooling2d_3.apply( conv2d_3 );

            let conv2d_4 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 128, strides: 1, padding: "same", name: "conv2d_4"
            } );

            conv2d_4.apply( max_pooling2d_3 );

            let max_pooling2d_4 = new TSP.layers.Pooling2d( {
                poolSize: [2, 2],  strides: [2, 2],  padding: "same", name: "max_pooling2d_4"
            } );

            max_pooling2d_4.apply( conv2d_4 );

            let conv2d_5 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 256, strides: 1, padding: "same", name: "conv2d_5"
            } );

            conv2d_5.apply( max_pooling2d_4 );

            let max_pooling2d_5 = new TSP.layers.Pooling2d( {
                poolSize: [2, 2],  strides: [2, 2],  padding: "same", name: "max_pooling2d_5"
            } );

            max_pooling2d_5.apply( conv2d_5 );

            let conv2d_6 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 512, strides: 1, padding: "same", name: "conv2d_6"
            } );

            conv2d_6.apply( max_pooling2d_5 );

            let max_pooling2d_6 = new TSP.layers.Pooling2d( {
                poolSize: [2, 2],  strides: [1, 1],  padding: "same", name: "max_pooling2d_6"
            } );

            max_pooling2d_6.apply( conv2d_6 );

            let conv2d_7 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 1024, strides: 1, padding: "same", name: "conv2d_7"
            } );

            conv2d_7.apply( max_pooling2d_6 );

            let conv2d_8 = new TSP.layers.Conv2d( {
                kernelSize: 1, filters: 256, strides: 1, padding: "same", name: "conv2d_8"
            } );

            conv2d_8.apply( conv2d_7 );

            let conv2d_9 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 512, strides: 1, padding: "same", name: "conv2d_9"
            } );

            conv2d_9.apply( conv2d_8 );

            let conv2d_10 = new TSP.layers.Conv2d( {
                kernelSize: 1, filters: 255, strides: 1, padding: "same", name: "conv2d_10"
            } );

            conv2d_10.apply( conv2d_9 );

            let conv2d_11 = new TSP.layers.Conv2d( {
                kernelSize: 1, filters: 128, strides: 1, padding: "same", name: "conv2d_11"
            } );

            conv2d_11.apply( conv2d_8 );

            let up_sampling2d_1 = new TSP.layers.UpSampling2d( {
                size: [ 2, 2 ], name: "up_sampling2d_1"
            } );

            up_sampling2d_1.apply( conv2d_11 );

            let concatenate_1 = new TSP.layers.Concatenate( [ conv2d_5, up_sampling2d_1 ], { name: "concatenate_1"} );

            let conv2d_12 = new TSP.layers.Conv2d( {
                kernelSize: 3, filters: 256, strides: 1, padding: "same", name: "conv2d_12"
            } );

            conv2d_12.apply( concatenate_1 );

            let conv2d_13 = new TSP.layers.Conv2d( {
                kernelSize: 1, filters: 256, strides: 1, padding: "same", name: "conv2d_13"
            } );

            conv2d_13.apply( conv2d_12 );

            let yoloGrid = new TSP.layers.YoloGrid( {

                anchors: [ 10,14,  23,27,  37,58,  81,82,  135,169,  344,319 ],

                //coco class label name list
                classLabelList: [ 'person',
                    'bicycle',
                    'car',
                    'motorbike',
                    'aeroplane',
                    'bus',
                    'train',
                    'truck',
                    'boat',
                    'traffic light',
                    'fire hydrant',
                    'stop sign',
                    'parking meter',
                    'bench',
                    'bird',
                    'cat',
                    'dog',
                    'horse',
                    'sheep',
                    'cow',
                    'elephant',
                    'bear',
                    'zebra',
                    'giraffe',
                    'backpack',
                    'umbrella',
                    'handbag',
                    'tie',
                    'suitcase',
                    'frisbee',
                    'skis',
                    'snowboard',
                    'sports ball',
                    'kite',
                    'baseball bat',
                    'baseball glove',
                    'skateboard',
                    'surfboard',
                    'tennis racket',
                    'bottle',
                    'wine glass',
                    'cup',
                    'fork',
                    'knife',
                    'spoon',
                    'bowl',
                    'banana',
                    'apple',
                    'sandwich',
                    'orange',
                    'broccoli',
                    'carrot',
                    'hot dog',
                    'pizza',
                    'donut',
                    'cake',
                    'chair',
                    'sofa',
                    'pottedplant',
                    'bed',
                    'diningtable',
                    'toilet',
                    'tvmonitor',
                    'laptop',
                    'mouse',
                    'remote',
                    'keyboard',
                    'cell phone',
                    'microwave',
                    'oven',
                    'toaster',
                    'sink',
                    'refrigerator',
                    'book',
                    'clock',
                    'vase',
                    'scissors',
                    'teddy bear',
                    'hair drier',
                    'toothbrush', ],

                // default is 0.5
                scoreThreshold: 0.3,

                // default is 0.3
                iouThreshold: 0.3,

                // default is true
                isDrawFiveBoxes: true,

                // default is true
                isNMS: true,

                onCeilClicked: onYoloCeilClicked

            } );

            let model = new TSP.models.Model( modelContainer, {

                stats: true,
                animationTimeRatio: 0.1,
                inputs: [ input ],
                outputs: [ conv2d_10, conv2d_13 ]

            } );

            model.load( {

                type: "tfjs",
                url: './yolov3-tiny-coco/yolov3-tiny.json'

            } );

            model.init( function() {

				$.ajax( {

					url: "./data/person.json",
					type: 'GET',
					async: true,
					dataType: 'json',
					success: function ( data ) {

						model.predict( [ data ] );
						$( "#loadingPad" ).hide();

					}

				} );

            } );

            function onYoloCeilClicked( ceilData, rectList ) {

                outputDetectionLayer.addRectangleList( rectList );

                if ( !outputDetectionLayer.isOpen ) {

                    outputDetectionLayer.openLayer();

                }

            }

        </script>
    </body>
</html>
